# 一、什么是单片机？

## 1.2 单片机的发展历史

### 第一阶段(1974-1976年)：单片机初始阶段

- 计算机主要由**控制器、运算器、输入设备、输出设备、存储器**组成

- 冯诺依曼提出“程序存储”和“二进制运算”的思想，构建了计算机经典结构：

- 主要元器件为**电子管**

  ![1561015676231](C:\Users\lyw\AppData\Roaming\Typora\typora-user-images\1561015676231.png)

### 第二阶段（1976-1978）：低性能单片机阶段

- 晶体管代替电子管
- 磁芯使用用作主存储器，磁盘用作外存储器
- 开始使用高阶语言

### 第三阶段（1965-1970年）：高性能单片机阶段

- 集成电路计算机，使用中小集成电路取代晶体管

### 第四阶段（1983年至今）：8位单片机巩固发展及16位、32位单片机推出阶段

- 采用了大规模集成电路和超大规模集成电路

## 1.3 单片机特点：

- 简单方便，易于掌握和普及
- 功能齐全，应用可靠，抗干扰能力强
- 发展迅速，前景广阔
- 嵌入容易，用途广泛

## 1.4 单片机的应用

### 1.工业控制与检测

### 2.仪器仪表

### 3.消费类电子产品

### 4.通信

### 5.武器装备

### 6.各种终端及计算机外部设备

### 7.汽车电子设备

### 8.分布式多机系统

## 1.5 单片机的发展趋势

### 1.CPU的改进

- 增加数据总线的宽度。例如，各种16位单片机和32位单片机，其数据处理能力要优于8位单片机。另外，8位单片机内部采用16位数据总线，其数据处理能力明显优于一般8位单片机。
- 采用双CPU结构，提高数据处理能力。

### 2.存储器的发展

- **片内程序存储器**普遍采用闪烁（flash）存储器。闪烁存储器能在+5v下读写，既有静态RAM的读写操作简便，又有在掉电时数据不会丢失的优点。单片机可不用扩展外部程序存储器，这大大简化了系统的硬件结构。
- 加大**片内数据存储器**存储容量，以满足动态数据存储的需要。

### 3.片内I/O的改进

- 增加并行口的驱动能力，以减少外部驱动芯片。
- 有些单片机设置了一些特殊的串行I/O功能，为构造分布式、网络化系统提供了方便条件。
- 引入了数字交叉开关，改变了以往片内外设与外部I/O引脚的固定对应关系。

### 4.低功耗

- 目前单片机产品均为CMOS化芯片，具有功耗小的优点。
- 这类单片机普遍配置有等待状态、睡眠状态、关闭状态等工作方式。
- 在这些状态下，低电压工作的单片机消耗的电流仅在uA或nA量级，将内部外设资源分配给端口I/O引脚。

### 5.外围电路内装化

随着集成电路技术和工艺不断发展，把所需众多外围电路全部装入单片机内，即系统的单片机化是目前单片机发展趋势之一，一个芯片就是一个测控系统

### 6.编程及仿真简单化

大多数单片机都支持程序的在线编程

### 7.实时操作系统的使用

单片机可配置实时操作系统RTX51，RTX51是一个针对8051单片机的多任务内核。RTX51实时内核从本质上简化了对实时事件反应速度要求较高的复杂系统设计、编程和调试，它已完全集成到C51编译器中，使用简单方便。

## 1.6 MCS-51系列与AT89S5x系列单片机

### 1.6.1 MCS-51系列单片机

- 基本型：8031、8051、8751
- 增强型：8032、8052、8072

### 1.6.2 AT89S5x系列单片机

#### 1.8051内核单片机与AT89S5x系列单片机

- ATMEL公司将8051内核与flash存储技术结合，形成了片内带有flash存储器的AT89C5x/AT89S5x系列单片机。
- AT89C5x与AT89S5x的区别：S表示含有串行下载的flash存储器，并且S系列的时钟频率和运算速度都有了较大提升。

#### 2.AT89系列单片机的型号说明

- 前缀：由字母“AT”组成，他表示是ATMEL公司的产品。
- 型号：由“89CXXXX”或“89LVXXXX”或“89SXXXX”等表示
  - “89CXXXX”中，8表示单片，9表示内部含有flash存储器，C表示CMOS产品。
  - “89LVXXXX”中，LV表示低电压产品，可在2.5v电压下工作。
  - “89SXXXX”中，S表示含有串行下载的flash存储器，而“XXXX”表示器件的型号，如51、52、2051、8052等
- 后缀：后缀由四个"XXXX"参数组成，每个参数意义不同。在型号与后缀部分由"-"号隔开。
  - 第一个"X"表示时钟频率
  - 第二个"X"表示封装
  - 第三个"X"表示温度使用范围
  - 第四个"X"表示工艺

# 二、AT89S51单片机片内硬件结构

## AT89S51单片机的片内硬件结构

- CPU（微处理器）：8位的CPU，包括了运算器和控制器两大部分，此外还有面向控制的位处理和位控功能。
- 数据存储器（RAM）：片内为128B（增强型52子系列为256B），片外最多还可外扩64KB的数据存储器。
- 程序存储器（Flash ROM）：用来存储程序。AT89S51片内有4KB的Flash存储器（AT89S52片内有8KB的Flash存储器），如果片内程序存储容量不够，片外最多可以外扩64KB程序存储器。
- 中断系统：具有5个中断源，2个中断优先权。
- 定时器/计数器：片内有2个16位的定时/计数器（增强版的52子系列有3个16位的定时器/计数器）
- 串行口：1个全双工的异步串行口（UART），具有4种工作方式。可以进行串口通信，扩展并行I/O口，还可与多个单片机相连构成多机串行通信系统。
- 4个8位的并行口：P0口、P1口、P2口和P3口
- 特殊功能寄存器（SFR）：共有26个特殊功能寄存器，用于CPU对片内各外围部件进行管理、控制和监视。特殊功能寄存器实际上是片内各外围部件的控制寄存器和状态寄存器，这些特殊功能的寄存器映射在片内RAM区的80H~FFH的地址区间内。
- 1个看门狗定时器WDT：当单片机由于干扰而使程序陷入死循环或跑飞状态时，可引起单片机复位，从而使程序恢复正常运行。

## AT89S51的引脚功能

AT89S51与8051单片机的引脚是互相兼容的。目前AT89S51单片机多采用40只引脚的塑料双列直插封装（DIP）模式。

![1561038155538](C:\Users\lyw\AppData\Roaming\Typora\typora-user-images\1561038155538.png)

此外，他还有44引脚的PLCC和TQEP封装方式的芯片

40只引脚按功能可分为如下三类：

- 电源及时钟引脚：Vcc、Vss、XTAL1、XTAL2；
- 控制引脚：非PSEN、ALE/非PROG、非EA/Vpp、RST（即RESET）；
- I/O口引脚：P0、P1、P2和P3，为4个8位并行I/O口的外部引脚。

### 2.2.1 电源及时钟引脚

#### 1.电源引脚

- Vcc（40脚）：接+5V电源。
- Vss（20脚）：接数字地。

#### 2.时钟引脚

- XTAL1（19脚）：片内振荡器的反相放大器和外部时钟发生器的输入端。使用AT89S51单片机片内振荡器时，该引脚外接石英晶体和微调电容。当采用外部的独立时钟源时，本引脚接外部时钟振荡器的信号。
- XTAL2（12脚）：片内振荡器反相放大器的输出端。当使用片内振荡器时，该引脚连接外部石英晶体和微调电容。当使用外部时钟振荡器时，本引脚悬空。

### 2.2.2 控制引脚

控制引脚提供控制信号，有的引脚还具有复用功能。

#### 1.RST（RESET，9脚）

- 复位信号输入端，高电平有效。
- 在此引脚加上持续时间大于两个机器周期的高电平，就可使单片机复位。在单片机正常工作时，此引脚应为<=0.5v的低电平。
- 当看门狗定时器溢出输出时，该引脚将输出长达96个时钟振荡周期的高电平。

#### 2.非EA/Vpp（31脚）

- 第一功能：非EA：外部程序存储器访问允许控制端
- 第二功能：Vpp：在对片内Flash进行编程时，Vpp引脚接入变成电压。

#### 3.ALE/非PROG（30脚）

- 第一功能（ALE）：CPU访问外部程序存储器或外部数据存储器提供低8位地址的锁存控制信号，将单片机P0口发出的低8位地址锁存在片外的地址锁存器中。
- 第二功能（非PROG）：在对片内Flash存储器编程时，此引脚作为编程脉冲输入端。

#### 4.非PSEN

片内或片外程序存储器的读选通信号，低电平有效。

### 2.2.3 并行I/O口引脚

#### 1.P0口：P0.7 ~ P0.0引脚：

- 漏极开路的双向I/O口
- P0口也可作为通用I/O口使用，但需加上上拉电阻，这时为准双向口。P0口可驱动8个LS型TTL负载

#### 2.P1口：P1.7 ~ P1.0引脚：

- 准双向I/O口，具有内部上拉电阻，可驱动4个LS型TTL负载。
- P1口是完全可以提供给用户使用的准双向I/O口。
- P1.5/MOSI、P1.6/MISO和P1.7/SCK也可以用于对片内Flash存储器的串行编程和校验，它们分别是串行数据输入、串行数据输出和移位脉冲引脚。

#### 3.P2口：P2.7~P2.0引脚

- 准双向I/O口，具有内部上拉电阻，可驱动4个LS型TTL负载。
- 当AT89S51扩展外部存储器及I/O口时，P2口作为高8位地址总线用，输出高8位地址。
- P2口也可以作为通用I/O口使用。

#### 4.P3口：P3.7 ~ P3.0引脚

- 准双向I/O口，具有内部上拉电阻。

- P3口也可以作为通用I/O口使用，可驱动4个LS型TTL负载。

- P3口还可以提供第二功能，其第二功能定义如图所示：

  ![img](https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1561050578795&di=5b693aa589ee0007ed278fb191eecfd5&imgtype=0&src=http%3A%2F%2Fwww.51dzw.com%2FUploadFiles%2F20140609%2F20140609214460116011.jpg)

## 2.3 AT89S51的CPU

### 2.3.1 运算器

#### 1. 算术逻辑运算单元（ALU）

- ALU不仅可对8位变量进行逻辑与、或、异或以及循环、求补和清零等操作，还可以进行加减乘除等基本运算。
- ALU还具有位操作功能，可对位（bit）变量进行位处理，如置“1”、清零、求补、测试转移及逻辑“与”“或”等操作。

#### 2.累加器（A）

- 是ALU单元的输入数据源之一，同时又是ALU运算结果的存放单元。
- CPU中的数据传送大多都通过累加器A，累加器A又相当于数据的中转站。
- 累加器A的进位位Cy（位于程序状态字特殊功能寄存器PSW中）是特殊的，因为它同时又是位处理器的位累加器。

#### 3.程序状态字寄存器（PSW）

- 位于单片机的特殊寄存器区，字节地址为D0H。

- PSW的不同位包含了程序运行状态的不同信息，其中4位保存当前指令执行后的状态，以供程序查询和判断。PSW的格式如图所示。

  ![1561090605795](C:\Users\lyw\AppData\Roaming\Typora\typora-user-images\1561090605795.png)

PSW中各个位的功能如下：

- Cy（PSW.7）进位标志位：也可写为C。在执行算数运算和逻辑运算指令时，若有进位/借位，则Cy=1；否则，Cy=0。在位处理器中，它是位累加器。

- Ac（PSW.6）辅助进位标志位：Ac表之位用于在BCD码运算时进行十进位调整，即在运算时，当D3位向D4位产生进位或借位时，Ac=1；否则，Ac=0.

- F0（PSW.5）用户使用的标志位：可用指令来使它置“1”或清零，也可用指令来测试标志位，根据测试结果控制程序的流向。编程时，用户应当充分利用该标志位。

- RS1、RS0（PSW.4、PSW.3）4组工作寄存器区选择控制位1和位0：这两位用来选择片内RAM区中的4组工作寄存器区中的某一组为当前工作寄存区，RS1、RS0与所选择的4组工作寄存器区的对应关系如表所示：

  ![img](https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1561104495710&di=b43c58dc8fb5cd7715584fcc3014af77&imgtype=0&src=http%3A%2F%2Fp.ananas.chaoxing.com%2Fstar3%2Forigin%2F3ab6a4356cf8e99c3241451ebac0333a.png)

  ![1561095288112](C:\Users\lyw\AppData\Roaming\Typora\typora-user-images\1561095288112.png)

- OV（PSW.2）溢出标志位：当执行算数指令时，OV用来指示运算结果是否产生溢出。如果结果产生溢出，OV=1；否则，OV=0.

- PSW.1位：保留位，未用

- P（PSW.0）奇偶校验位：该标志位表示指令执行完时，累加器A中"1"的个数是奇数还是偶数，如果是奇数则此位为1，如果是偶数则此位为0.

### 2.3.2 控制器

- 控制器主要包括程序计数器、指令寄存器-指令译码器、定时及控制电路等。其功能是控制指令的读入、译码和执行，从而对单片机的各功能部件进行定时和逻辑控制。
- 程序计数器PC是控制器中最基本的寄存器，它是一个独立的16位计数器，用户不能直接使用指令对PC进行读写。
- 当单片机复位时，PC中的内容为0000H，即CPU从程序存储器0000H单元取指令，并开始执行程序。
- PC的基本工作过程：CPU读取指令时，PC内容作为欲读取指令的地址发送给程序存储器，然后程序存储器按此地址输出指令字节，同时PC自动加1，这也是为什么PC被称为程序计数器的原因。由于PC实质上是作为程序寄存器的地址指针，所以也称其为程序指针。
- PC内容的变化轨迹决定了程序的流程。由于PC是用户不可直接访问的，当顺序执行程序时自动加1；执行转移程序或子程序或中断子程序调用时，有运行的指令自动将其内容更改成索要转移的目的地址。

## 2.4 AT89S51单片机存储器的结构

- 程序存储器空间（ROM）

  用来存放经调试正确的程序，片内为4KB的Flash存储器，最高可扩展片外64KB存储器。

- 数据存储器空间（RAM）

  AT89S51单片机内部有128B的RAM（52子系列有256B），用来存放读写数据，当片内RAM不够用时可最多扩展片外64KB的RAM。

- 特殊功能寄存器（SFR）

  SFR实际上是各外围部件的控制寄存器和状态寄存器，综合反映了单片机内部的工作状态和工作方式。

- 位地址空间

  AT89S51单片机共有211个可寻址位，构成了位地址空间。他们位于片内RAM区地址20H-2FH（共128位）和特殊功能寄存器区（片内RAM字节地址80H~FFH，共计83位）。

### 2.4.1 程序存储器空间

程序存储器是只读存储器（ROM），AT89S51的片内程序存储器为4KB的Flash存储器，地址范围为0000H~0FFFH。AT89S51单片机有16位地址总线，可外扩的程序存储器空间最大为64KB，地址范围为0000H~FFFFH。

- 访问方式：1.如果EA=1，PC值没有超出0FFFH时，CPU只读取片内RAM，若超出0FFFH会读取片外RAM

  ​				   2.如果EA=0，CPU将直接读取片外RAM。


### 2.4.2 数据存储器空间

1.片内数据存储器

![æ¥çæºå¾å](http://www.eeworld.com.cn/uploadfile/2017/1228/1514469249892051.jpg)

- AT89S51单片机的片内数据存储器（RAM）共有128个单元，字节地址为00H~7FH。
- 20H~2FH可以进行位寻址也可以进行字节寻址，30H~7FH只能进行字节寻址。

2.片外数据寄存器

AT89S51最多可拓展64KB的片外RAM，因为访问时会查询指令（EA），因此不会发生冲突。

### 2.4.3 特殊功能寄存器（SFR）

![æ¥çæºå¾å](http://www.eeworld.com.cn/uploadfile/2017/1228/1514469250853753.jpg)

特殊功能寄存器映射在片内RAM的80H~FFH之间，共有26个，离散的分布在该区域中。

1.堆栈指针SP

- 保护断点：在执行函数时主程序都会被打断，因此SP会将断点保护起来，为程序的正确返回做准备。
- 现场保护：在单片机执行子程序或中断服务子程序时，可能会产生新的变量，这昂就会破坏寄存器单元的原有内容，因此可将这些内容事先在堆栈中保存起来，防止数据丢失。

2.寄存器（B）

执行乘除法时使用，乘积放在BA中，B寄存器存放高8位，A寄存器存放低8位；除法时，被除数来自A，除数来自B，商存放在A中，余数存放在B中。

3.AUXR寄存器

没看懂

4.AUXR1寄存器

和上面一样

5.数据指针DPTR0和DPTR1

同上

6.看门狗定时器（WDT）

- 看门狗定时器包括**一个14位计数器和看门狗复位寄存器（WDTRST）**。当程序由于干扰，程序陷入死循环和跑飞状态时，看门狗定时器将使程序恢复正常。

- 若启动看门狗定时器则必须记住定期将其清零，否则程序将会不正常复位。

- 14位计数器即2^14（16384us）溢出一次，时钟为12MHz下。

- 看门狗的使用举例如下

  ~~~c
  #include<reg51.h>
  sfr WDTRST = 0xa6;
  void main(){
      ……;
      WDTRST = 0x1e;
      WDTRST = 0xe1; //经过这两次置位看门狗开始计数
      while(1){
          WDTRST = 0x1e;
          WDTRST = 0xe1; //在死循环中一定要记住将看门狗定时器重新置位否则看门狗定时器溢出会发生不正常的置位
      }
  }
  ~~~

### 2.4.4 位地址空间

![img](file:///C:\lyw\lyw_software\qq_file\378305181\Image\C2C\}X{D$4619D_OZO4J2OD%~6T.png)

![æ¥çæºå¾å](http://www.eeworld.com.cn/uploadfile/2017/1228/1514469254513268.jpg)

![æ¥çæºå¾å](http://www.eeworld.com.cn/uploadfile/2017/1228/1514469256102565.jpg)

